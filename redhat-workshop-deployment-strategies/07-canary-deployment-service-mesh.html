<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Canary deployment strategy with service mesh :: Red Hat Workshop - Deployment Strategies with Argo CD and Argo Rollouts</title>
    <link rel="canonical" href="https://github.com/davidseve/redhat-workshop-deployment-strategies/redhat-workshop-deployment-strategies/07-canary-deployment-service-mesh.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://github.com/davidseve/redhat-workshop-deployment-strategies">Red Hat Workshop - Deployment Strategies with Argo CD and Argo Rollouts</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="redhat-workshop-deployment-strategies" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#01-prerequisites">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html#01-laboratory">1.2 Laboratory</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-parameters">1.2.1 Parameters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessconsole">1.2.2 Access - OCP Console</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accesscli">1.2.3 Access - OCP CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessArgoCD">1.2.4 Access - ArgoCD dashboard</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-cloneGit">1.2.5 Clone the GitOps repository</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-deployment-strategies.html">2. Deployment Strategies with Argo CD and Argo Rollouts</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-blue-green-deployment.html">3. Blue/Green deployment strategy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-canary-deployment.html">4. Canary deployment strategy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Annex-1-cluster-setup.html">Annex 1 - Cluster Setup</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Workshop</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Workshop</a></li>
    <li><a href="07-canary-deployment-service-mesh.html">Canary deployment strategy with service mesh</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/davidseve/redhat-workshop-deployment-strategies/edit/master/documentation/modules/ROOT/pages/07-canary-deployment-service-mesh.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Canary deployment strategy with service mesh</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In the previous section, we have executed a canary deployment with out traffic management. When we set 10% weight it does not mean that 10% of the traffic goes to the new version. To achieve this we are going to have traffic management using <strong>Openshift Service Mesh</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_dstrategies_application"><a class="anchor" href="#_deploy_dstrategies_application"></a>Deploy Dstrategies Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to create the application <code>dstrategies</code>, that we will use to test canary deployment with service mesh. Because we will make changes in the application&#8217;s GitHub repository, we have to use the repository that you have just forked. Please edit the following yaml and set your own GitHub repository in the <code>reportURL</code>. Create a file called `application-dstrategies-canary-service-mesh.yaml`</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dstrategies-canary-service-mesh
  namespace: %USER%-gitops-argocd
spec:
  destination:
    name: ''
    namespace: %USER%-canary-service-mesh
    server: 'https://kubernetes.default.svc'
  source:
    path: helm/helm-umbrella-dstrategies/chart
    repoURL: <a href="https://github.com/change_me/dstrategies-helm-chart" class="bare">https://github.com/change_me/dstrategies-helm-chart</a>
    targetRevision: HEAD
    helm:
      parameters:
      - name: "global.namespace"
        value: %USER%-canary-service-mesh
      valueFiles:
        - values/canary-service-mesh/values.yaml
        - values/canary-service-mesh/values-image-tag.yaml
        - values/canary-service-mesh/values-rollouts-strategy.yaml
  project: default
  syncPolicy:
    automated:
      prune: false
      selfHeal: true</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc apply -f `application-dstrategies-canary-service-mesh.yaml`</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the Argo CD dashboard, you would notice that we have a new <code>dstrategies</code> application.</p>
</div>
<div class="paragraph">
<p>TODO mesh
image::argocd_dstrategies-canary-service-mesh.png["ArgoCD Dstrategies"]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_architecture"><a class="anchor" href="#_application_architecture"></a>Application architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_dstrategies_application"><a class="anchor" href="#_test_dstrategies_application"></a>Test Dstrategies application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have deployed the <code>dstrategies</code> with ArgoCD. We can test that it is up and running.</p>
</div>
<div class="literalblock">
<div class="content">
<pre> TODO change to front image
We have to get the Online route</pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes dstrategies-back-online -n %USER%-canary-service-mesh --template='https://{{.spec.host}}')/dstrategies-back"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in each microservice response we have added metadata information to see better the <code>version</code> of each application. This will help us to see the changes while we do the canary deployment.
We can see that the current version is <code>V1.0.0</code>:</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dstrategies_back_canary_deployment_with_service_mesh"><a class="anchor" href="#_dstrategies_back_canary_deployment_with_service_mesh"></a>Dstrategies-back canary deployment with service mesh</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have split a <code>Cloud Native</code> Canary deployment into three automatic step:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy canary version for 10%</p>
</li>
<li>
<p>Scale the canary version to 50%</p>
</li>
<li>
<p>Scale the canary version to 100%</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is just an example. The key point here is that very easily we can have the canary deployment that better fits our needs. To make this demo faster we have not set a pause without duration in any step, so  <strong>Argo Rollouts</strong> will go throw each step automatically.</p>
</div>
<div class="sect2">
<h3 id="_step_1_deploy_the_canary_version_for_10"><a class="anchor" href="#_step_1_deploy_the_canary_version_for_10"></a>Step 1 - Deploy the canary version for 10%</h3>
<div class="paragraph">
<p>We will deploy a new version V2.0.0. To do it, we have to edit the file <code>helm/helm-umbrella-dstrategies/chart/values/canary-service-mesh/values-image-tag.yaml</code> under <code>dstrategies-back</code> set <code>tag</code> value to <code>v.1.1.1</code></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">dstrategies-back:
   image:
     tag: V2.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>Push the changes to start the deployment.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git add .
git commit -m "Change dstrategies-back version to V2.0.0"
git push</code></pre>
</div>
</div>
<div class="paragraph">
<p>ArgoCD will refresh the status after some minutes. If you don&#8217;t want to wait you can refresh it manually from ArgoCD UI.</p>
</div>
<div class="paragraph">
<p>TODO mesh
image::argocd-Dstrategies-canary-service-mesh-Refresh.png["Refresh Dstrategies"]</p>
</div>
<div class="paragraph">
<p>This is our current status:</p>
</div>
<div class="paragraph">
<p>TODO mesh
image::canary-service-mesh-rollout-step-1.png["Dstrategies Step 1]</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">kubectl argo rollouts get rollout dstrategies-back --watch -n %USER%-canary-service-mesh</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>TODO chang to front image
In the dstrategies-back URL response, you will have the new version in 25% of the requests.</p>
</div>
<div class="paragraph">
<p>New revision:</p>
</div>
<div class="paragraph">
<p>Old revision:</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_scale_the_canary_version_to_50"><a class="anchor" href="#_step_2_scale_the_canary_version_to_50"></a>Step 2 - Scale the canary version to 50%</h3>
<div class="paragraph">
<p>After 30 seconds <strong>Argo Rollouts</strong> automatically will increase the number of replicas in the new release to 2. Instead of increasing automatically after 30 seconds, we can configure <strong>Argo Rollouts</strong> to wait indefinitely until that <code>Pause</code> condition is removed. But this is not part of this demo.
This is our current status:</p>
</div>
<div class="paragraph">
<p>TODO mesh
image::canary-service-mesh-rollout-step-2.png["Dstrategies Step 2"]</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">kubectl argo rollouts get rollout dstrategies-back --watch -n %USER%-canary-service-mesh</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_scale_the_canary_version_to_100"><a class="anchor" href="#_step_3_scale_the_canary_version_to_100"></a>Step 3 - Scale the canary version to 100%</h3>
<div class="paragraph">
<p>After another 30 seconds, <strong>Argo Rollouts</strong> will increase the number of replicas in the new release to 4 and scale down the old revision.</p>
</div>
<div class="paragraph">
<p>This is our current status:</p>
</div>
<div class="paragraph">
<p>TODO mesh
image::canary-service-mesh-rollout-step-3.png["Dstrategies Step 3"]</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">kubectl argo rollouts get rollout dstrategies-back --watch -n %USER%-canary-service-mesh</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p><strong>We have in the online environment the new version V2.0.0!!!</strong></p>
</div>
<div class="paragraph">
<p>TODO chang to front image</p>
</div>
</div>
<div class="sect2">
<h3 id="_rollback"><a class="anchor" href="#_rollback"></a>Rollback</h3>
<div class="paragraph">
<p>Imagine that something goes wrong, we know that this never happens but just in case. We can do a very <code>quick rollback</code> just by undoing the change.</p>
</div>
<div class="paragraph">
<p><strong>Argo Rollouts</strong> has an [undo](<a href="https://argoproj.github.io/argo-rollouts/generated/kubectl-argo-rollouts/kubectl-argo-rollouts_undo/" class="bare">https://argoproj.github.io/argo-rollouts/generated/kubectl-argo-rollouts/kubectl-argo-rollouts_undo/</a>) command to do the rollback. In my opinion, I don&#8217;t like this procedure because it is not aligned with GitOps. The changes that <strong>Argo Rollouts</strong> do does not come from git, so git is OutOfSync with what we have in Openshift.
In our case the commit that we have done not only changes the ReplicaSet but also the ConfigMap. The <code>undo</code> command only changes the ReplicaSet, so it does not work for us.</p>
</div>
<div class="paragraph">
<p>I recommend doing the changes in git. We will revert the last commit</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git revert HEAD --no-edit</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we just revert the changes in git we will go back to the previous version. But <strong>Argo Rollouts</strong> will take this revert as a new release so it will do it throw the steps that we have configured. We want a <code>quick rollback</code> we don&#8217;t want a step-by-step revert. To achieve the <code>quick rollback</code> we will configure <strong>Argo Rollouts</strong> without steps for the rollback.</p>
</div>
<div class="paragraph">
<p>Because we have our <strong>Argo Rollouts</strong> configuration as values in our Helm Chart, we have just to edit the values.yaml that we are using.</p>
</div>
<div class="paragraph">
<p>In the file <code>helm/helm-umbrella-dstrategies/chart/values/canary-service-mesh/values-rollouts-strategy.yaml</code> under <code>dstrategies-back</code> under the <code>steps</code> delete all the steps and only set one step <code>- setWeight: 100</code></p>
</div>
<div class="paragraph">
<p><code>helm/helm-umbrella-dstrategies/chart/values/canary-service-mesh/values-rollouts-strategy.yaml</code> should looks like:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">dstrategies-back:
   rollouts:
      canary:
         steps:
            - setWeight: 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute those commands to push the changes:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git add .
git commit -m "delete steps for rollback"
git push</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>ArgoCD</strong> will get the changes and apply them. <strong>Argo Rollouts</strong> will create a new revision with the previous version.</p>
</div>
<div class="paragraph">
<p>The rollback is done!</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="canary-service-mesh-rollout-step-Rollback.png" alt="Dstrategies Step Rollback">
</div>
</div>
<div class="paragraph">
<p>TODO chang to front image</p>
</div>
<div class="paragraph">
<p>To get the application ready for a new release we should configure again the  <strong>Argo Rollouts</strong> with the steps.</p>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
