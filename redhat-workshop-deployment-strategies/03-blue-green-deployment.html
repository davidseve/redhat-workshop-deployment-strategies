<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Blue/Green deployment strategy :: RHTE Workshop - Deployment Strategies with Argo CD and Argo Rollouts</title>
    <link rel="canonical" href="https://github.com/rhte2023-argo-rollouts/redhat-workshop-deployment-strategies/redhat-workshop-deployment-strategies/03-blue-green-deployment.html">
    <link rel="prev" href="02-deployment-strategies.html">
    <link rel="next" href="04-canary-deployment.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://github.com/rhte2023-argo-rollouts/redhat-workshop-deployment-strategies">RHTE Workshop - Deployment Strategies with Argo CD and Argo Rollouts</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="redhat-workshop-deployment-strategies" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#01-prerequisites">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html#01-laboratory">1.2 Laboratory</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-parameters">1.2.1 Parameters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessconsole">1.2.2 Access - OCP Console</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accesscli">1.2.3 Access - OCP CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessArgoCD">1.2.4 Access - ArgoCD dashboard</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-cloneGit">1.2.5 Clone the GitOps repository</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-deployment-strategies.html">2. Deployment Strategies with Argo CD and Argo Rollouts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deployment-strategies.html#02-dstrategies-app">2.1 DStrategies App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-deployment-strategies.html#02-deployment-strategies">2.2 Deployment Strategies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-deployment-strategies.html#02-micro-arch">2.2.1 Microservices Architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-deployment-strategies.html#02-cd">2.2.2 Continuous Delivery</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-deployment-strategies.html#02-pd">2.2.3 Progressive Delivery</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-deployment-strategies.html#02-argo-rollouts">2.2.4 Argo Rollouts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="02-deployment-strategies.html#02-bg">2.2.4.1 Blue/Green Deployment</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="02-deployment-strategies.html#02-canary">2.2.4.2 Canary Deployment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="03-blue-green-deployment.html">3. Blue/Green deployment strategy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-canary-deployment.html">4. Canary deployment strategy</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Workshop</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Workshop</a></li>
    <li><a href="03-blue-green-deployment.html">3. Blue/Green deployment strategy</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rhte2023-argo-rollouts/redhat-workshop-deployment-strategies/edit/master/documentation/modules/ROOT/pages/03-blue-green-deployment.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Blue/Green deployment strategy</h1>
<div class="sect1">
<h2 id="_application_architecture"><a class="anchor" href="#_application_architecture"></a>Application architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As mentioned before, we have a very simple application that has two services. One frontal React app call <strong>DStrategies-front</strong> and one backend Quarkus app call <strong>dstrategies-back</strong>. We will use the front app to call several times the back app and see how the back version change during the deployment.</p>
</div>
<div class="paragraph">
<p>To achieve Blue/Green deployment with <strong>Cloud Native</strong> applications using <strong>Argo Rollouts</strong>, we have designed this architecture.</p>
</div>
<div class="paragraph">
<p>This is the initial situation after deploying the application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-0.png" alt="DStrategies initial status">
</div>
</div>
<div class="paragraph">
<p>OpenShift Components - Online</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Routes and Services declared with the suffix -online</p>
</li>
<li>
<p>Routes mapped only to the online services</p>
</li>
<li>
<p>Services mapped to the rollout.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OpenShift Components - Offline</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Routes and Services declared with the suffix -offline</p>
</li>
<li>
<p>Routes mapped only to the offline services</p>
</li>
<li>
<p>Services mapped to the rollout</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will define an active or online service 'dstrategies-back-online' and a preview or offline service 'dstrategies-back-offline'. The idea is the frontend will always use 'dstrategies-back-online' and 'dstrategies-back-offline' will only be used to test our service before trigerring the rollout.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generate_dstrategies_app_gitops_deployment_model"><a class="anchor" href="#_generate_dstrategies_app_gitops_deployment_model"></a>Generate DStrategies APP GitOps Deployment Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First of all, it is required to review a set of objects in a our forked git repository in order to configure the deployment correctly for deploying our application following a GitOps model.</p>
</div>
<div class="paragraph">
<p>Please follow the next section to understand the required objects and configurations.</p>
</div>
<div class="sect2">
<h3 id="_review_services"><a class="anchor" href="#_review_services"></a>Review Services</h3>
<div class="paragraph">
<p>As the previous picture showns, it is required to generate a couple of services that will be used to redirect the traffic to the correct DStrategies App version.</p>
</div>
<div class="paragraph">
<p>Please take a look at the files <strong>./blue-green/dstrategies-back-service-online.yaml</strong> and <strong>./blue-green/dstrategies-back-service-offline.yaml</strong> in order to understand the objects and get the names of these elements.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modify_rollout_strategy"><a class="anchor" href="#_modify_rollout_strategy"></a>Modify Rollout strategy</h3>
<div class="paragraph">
<p>The Rollout object controls the application deployment. If you look closely, it is possible to find many similarities between an Argo Rollout objects and a Kubernetes Deployment. The main different btween the previous objects referenced is the rollout strategy field.</p>
</div>
<div class="paragraph">
<p>Please edit a file named <strong>./blue-green/dstrategies-back-rollout.yaml</strong> in oder to add the required <strong>&lt;SERVICE_OFFLINE&gt;</strong> and <strong>&lt;SERVICE_ONLINE&gt;</strong> service names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  strategy:
    blueGreen:
      activeService: &lt;SERVICE_ONLINE&gt;
      autoPromotionEnabled: false
      prePromotionAnalysis:
        templates:
          - templateName: dstrategies-back-analysis-template
      previewService: &lt;SERVICE_OFFLINE&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modify_analysis_template"><a class="anchor" href="#_modify_analysis_template"></a>Modify Analysis Template</h3>
<div class="paragraph">
<p>We have created an AnalysisTemplate 'dstrategies-back-analysis-template' that just validates the health of the application, for production environments a better analysis should be done. <strong>Argo Rollouts</strong> use this AnalysisTemplate to validate a new version and set whether it is ready to be promoted or not.</p>
</div>
<div class="paragraph">
<p>Please edit a file named <strong>./blue-green/dstrategies-back-analysis-template.yaml</strong> in oder to add the required <strong>&lt;USERNAME&gt;</strong> that helps to reference the user namespace in the healthcheck url.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  metrics:
    - name: dstrategies-back-webmetric
      provider:
        web:
          jsonPath: '{$.status}'
          url: &gt;-
            <a href="http://dstrategies-back-offline.&lt;USERNAME&gt;-blue-green.svc.cluster.local:8080/q/health/ready" class="bare">http://dstrategies-back-offline.&lt;USERNAME&gt;-blue-green.svc.cluster.local:8080/q/health/ready</a>
      successCondition: result == 'UP'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information about AnalysisTemplate, please visit the following <a href="https://argoproj.github.io/argo-rollouts/features/bluegreen/">link</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_modify_back_service_url"><a class="anchor" href="#_modify_back_service_url"></a>Modify back service URL</h3>
<div class="paragraph">
<p>Finally, it is required to create a <strong>Deployment</strong> object in order to deploy the frontend application. This application helps us to test the blue-green rollout strategy from a web interface and see backend information.</p>
</div>
<div class="paragraph">
<p>In order to allow communication between the frontend and the backend, it is required to edit the file named <strong>./blue-green/dstrategies-frontend-deployment.yaml</strong> in oder to add the required <strong>&lt;USERNAME&gt;</strong> and <strong>&lt;OCP_APPS_DOMAIN&gt;</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">        env:
          - name: REACT_APP_BACK
            value: <a href="http://dstrategies-back-online-&lt;USERNAME&gt;-blue-green.&lt;OCP_APPS_DOMAIN&gt;/dstrategies-back" class="bare">http://dstrategies-back-online-&lt;USERNAME&gt;-blue-green.&lt;OCP_APPS_DOMAIN&gt;/dstrategies-back</a>
          - name: REACT_APP_CATEGORY
            value: BLUE-GREEN</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_commit_and_push_the_changes"><a class="anchor" href="#_commit_and_push_the_changes"></a>Commit and Push the Changes</h3>
<div class="paragraph">
<p>Once all the files are configured correctly, it is time to commit and push all changes to the repository that you have just forked.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git add .
git commit -m "Configured DStrategies App deployment files"
git push</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_argo_cd_application"><a class="anchor" href="#_argo_cd_application"></a>Argo CD Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to create the application <strong>DStrategies</strong> in order to apply the files modified previously, that we will use to test Blue/Green deployment. Please edit the following yaml and set your own GitHub repository in the <strong>reportURL</strong>. Create a file called <strong>application-dstrategies-blue-green.yaml</strong></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dstrategies-blue-green
  namespace: %USER%-gitops-argocd
spec:
  destination:
    name: ''
    namespace: %USER%-blue-green
    server: 'https://kubernetes.default.svc'
  source:
    path: blue-green
    repoURL: <a href="https://github.com/change_me/dstrategies-app-deployment" class="bare">https://github.com/change_me/dstrategies-app-deployment</a>
    targetRevision: HEAD
  project: default
  syncPolicy:
    automated:
      prune: false
      selfHeal: true</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc apply -f application-dstrategies-blue-green.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the Argo CD dashboard, you would notice that we have a new <strong>DStrategies</strong> application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd_dstrategies-blue-green.png" alt="ArgoCD DStrategies">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to wait for <strong>Healthy</strong> and <strong>Synced</strong> status in the Argo CD Application
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_dstrategies_application"><a class="anchor" href="#_test_dstrategies_application"></a>Test Dstrategies application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have deployed the <strong>dstrategies</strong> with ArgoCD. We can test the online and offline services in order to ensure that they are up and running.</p>
</div>
<div class="paragraph">
<p>In order to test the online service, it is required to extract the frontend url:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route dstrategies-frontend -n %USER%-blue-green -o jsonpath='{.spec.host}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Visit the frontend route via your web browser, push - JUMP- button and ensure the following message is displaying in your screen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/frontend-blue-green.png" alt="Frontend Interface">
</div>
<div class="title">Figure 1. Frontend Interface</div>
</div>
<div class="paragraph">
<p>In addition, regarding testing the offline service, it is required to get the Offline route:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes dstrategies-back-offline -n %USER%-blue-green --template='http://{{.spec.host}}')/dstrategies-back"
{"metadata":{"version":"V1.0.0","colour":"Blue"}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in each microservice response we have added metadata information to see better the <strong>version</strong> of each application. This will help us to see the changes while we do the Blue/Green deployment.
Because right now we have both routers against the same rollout revision we will have the same response with version <strong>V1.0.0</strong>:</p>
</div>
<div class="paragraph">
<p>We can also see the rollout*s status.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Argo Rollouts offers a Kubectl plugin to enrich the experience with Rollouts <a href="https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation" class="bare">https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation</a>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc argo rollouts get rollout dstrategies-back --watch -n %USER%-blue-green</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">NAME                                  KIND        STATUS     AGE INFO
⟳ dstrategies-back                            Rollout     ✔ Healthy  12m
└──# revision:1
   └──⧉ dstrategies-back-67fc9fb79b           ReplicaSet  ✔ Healthy  12m  stable,active
      ├──□ dstrategies-back-67fc9fb79b-49k25  Pod         ✔ Running  12m  ready:1/1
      └──□ dstrategies-back-67fc9fb79b-p7jk9  Pod         ✔ Running  12m  ready:1/1</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dstrategies_back_bluegreen_deployment"><a class="anchor" href="#_dstrategies_back_bluegreen_deployment"></a>DStrategies-back Blue/Green deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have split a <strong>Cloud Native</strong> Blue/Green deployment into two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy a new version.</p>
</li>
<li>
<p>Promote a new version</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To test Blue/Green deployment we are going to do changes in the backend application dstrategies-back.</p>
</div>
<div class="paragraph">
<p>We have already deployed the dstrategies-back version V1.0.0, and we are ready to use a new dstrategies-back version V2.0.0 that has a new <strong>description</strong> attribute.</p>
</div>
<div class="sect2">
<h3 id="_step_1_deploy_a_new_version"><a class="anchor" href="#_step_1_deploy_a_new_version"></a>Step 1 - Deploy a new version</h3>
<div class="paragraph">
<p>We will deploy a new version <strong>V2.0.0</strong>. To do it, we have to edit the files <strong>./blue-green/dstrategies-back-rollout.yaml</strong> and <strong>./blue-green/dstrategies-back-configmap.yaml</strong> in order to modify the value <strong>v1.0.0</strong> to <strong>V2.0.0</strong>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">          image: 'quay.io/dseveria/dstrategies-back:V1.0.0' &lt;---</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">  application.version: V1.0.0 &lt;---</code></pre>
</div>
</div>
<div class="paragraph">
<p>And push the changes</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git add .
git commit -m "Change dstrategies-back version to V2.0.0"
git push</code></pre>
</div>
</div>
<div class="paragraph">
<p>ArgoCD will refresh the status after some minutes. If you don&#8217;t want to wait you can refresh it manually from ArgoCD UI.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-Dstrategies-blue-green-Refresh.png" alt="Refresh DStrategies">
</div>
</div>
<div class="paragraph">
<p><strong>Argo Rollouts</strong> will automatically deploy the new dstrategies-back version and execute the <strong>prePromotionAnalysis</strong>.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc argo rollouts get rollout dstrategies-back --watch -n %USER%-blue-green
NAME                                  KIND         STATUS        AGE  INFO
⟳ dstrategies-back                            Rollout      ॥ Paused      27m
├──# revision:2
│  ├──⧉ dstrategies-back-9dc6f576f            ReplicaSet   ✔ Healthy     36s  preview
│  │  ├──□ dstrategies-back-9dc6f576f-6vqp5   Pod          ✔ Running     36s  ready:1/1
│  │  └──□ dstrategies-back-9dc6f576f-lmgd7   Pod          ✔ Running     36s  ready:1/1
│  └──α dstrategies-back-9dc6f576f-2-pre      AnalysisRun  ✔ Successful  31s  ✔ 1
└──# revision:1
   └──⧉ dstrategies-back-67fc9fb79b           ReplicaSet   ✔ Healthy     27m  stable,active
      ├──□ dstrategies-back-67fc9fb79b-49k25  Pod          ✔ Running     27m  ready:1/1
      └──□ dstrategies-back-67fc9fb79b-p7jk9  Pod          ✔ Running     27m  ready:1/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <strong>prePromotionAnalysis</strong> goes well, we can see that offline applications have version V2.0.0 and the new attribute description, but the online version has not changed.</p>
</div>
<div class="paragraph">
<p>This is our current status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-1.png" alt="&quot;Dstrategies Step 1">
</div>
</div>
<div class="paragraph">
<p>In order to test the online service, it is required to extract the frontend url:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route dstrategies-frontend -n %USER%-blue-green -o jsonpath='{.spec.host}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Visit the frontend route via your web browser, push - JUMP- button and ensure the following message is displaying in your screen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/frontend-blue-green.png" alt="Frontend Interface">
</div>
<div class="title">Figure 2. Frontend Interface</div>
</div>
<div class="paragraph">
<p>In addition, regarding testing the offline service, it is required to get the Offline route and check the version is <strong>V2.0.0</strong>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes dstrategies-back-offline -n %USER%-blue-green --template='http://{{.spec.host}}')/dstrategies-back"
{"metadata":{"version":"V2.0.0","colour":"Blue"}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Functional testing users can execute <strong>Smoke tests</strong> to validate this new V2.0.0 version.</p>
</div>
<div class="paragraph">
<p>We have to be careful with those tests in a production environment because the product microservice will call the online dependencies.
If this dependency is for example a production DB we will create the things that our <strong>Smoke tests</strong> do.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_promote_a_new_version"><a class="anchor" href="#_step_2_promote_a_new_version"></a>Step 2 - Promote a new version</h3>
<div class="paragraph">
<p>We are going to open the new version to final users.</p>
</div>
<div class="paragraph">
<p>Execute this command to promote dstrategies-back:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc argo rollouts promote dstrategies-back -n %USER%-blue-green</code></pre>
</div>
</div>
<div class="paragraph">
<p>First <strong>Argo Rollouts</strong> will just change the service to use the new release (ReplicaSet). We <strong>minimize downtime</strong> because it just changes the service label.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc argo rollouts get rollout dstrategies-back --watch -n %USER%-blue-green
NAME                                  KIND         STATUS        AGE  INFO
⟳ dstrategies-back                            Rollout      ✔ Healthy     88m
├──# revision:2
│  ├──⧉ dstrategies-back-9dc6f576f            ReplicaSet   ✔ Healthy     62m  stable,active
│  │  ├──□ dstrategies-back-9dc6f576f-6vqp5   Pod          ✔ Running     62m  ready:1/1
│  │  └──□ dstrategies-back-9dc6f576f-lmgd7   Pod          ✔ Running     62m  ready:1/1
│  └──α dstrategies-back-9dc6f576f-2-pre      AnalysisRun  ✔ Successful  62m  ✔ 1
└──# revision:1
   └──⧉ dstrategies-back-67fc9fb79b           ReplicaSet   ✔ Healthy     88m  delay:27s
      ├──□ dstrategies-back-67fc9fb79b-49k25  Pod          ✔ Running     88m  ready:1/1
      └──□ dstrategies-back-67fc9fb79b-p7jk9  Pod          ✔ Running     88m  ready:1/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is our current status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-2-initial.png" alt="Dstrategies Step 2 initial">
</div>
</div>
<div class="paragraph">
<p>And after <strong>scaleDownDelaySeconds</strong> <strong>Argo Rollouts</strong> will scale down the first replicaSet (V1.0.0).</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc argo rollouts get rollout dstrategies-back --watch -n %USER%-blue-green
 NAME                                 KIND         STATUS        AGE  INFO
⟳ dstrategies-back                           Rollout      ✔ Healthy     89m
├──# revision:2
│  ├──⧉ dstrategies-back-9dc6f576f           ReplicaSet   ✔ Healthy     62m  stable,active
│  │  ├──□ dstrategies-back-9dc6f576f-6vqp5  Pod          ✔ Running     62m  ready:1/1
│  │  └──□ dstrategies-back-9dc6f576f-lmgd7  Pod          ✔ Running     62m  ready:1/1
│  └──α dstrategies-back-9dc6f576f-2-pre     AnalysisRun  ✔ Successful  62m  ✔ 1
└──# revision:1
   └──⧉ dstrategies-back-67fc9fb79b          ReplicaSet   • ScaledDown  89m</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is our final status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-2.png" alt="Dstrategies Step 2">
</div>
</div>
<div class="paragraph">
<p>In order to test the new online service, it is required to extract the frontend url:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route dstrategies-frontend -n %USER%-blue-green -o jsonpath='{.spec.host}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Visit the frontend route via your web browser, push - JUMP- button and ensure the following message is displaying in your screen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/frontend-blue-green-v2.png" alt="Frontend Interface V2.0.0">
</div>
<div class="title">Figure 3. Frontend Interface</div>
</div>
<div class="paragraph">
<p><strong>We have in the online environment the new version V2.0.0!!!</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_rollback"><a class="anchor" href="#_rollback"></a>Rollback</h3>
<div class="paragraph">
<p>Imagine that something goes wrong, we know that this never happens but just in case. We can do a very <strong>quick rollback</strong> just by undoing the change in the <strong>dstrategies-back</strong> online service.</p>
</div>
<div class="paragraph">
<p><strong>Argo Rollouts</strong> has an <a href="https://argoproj.github.io/argo-rollouts/generated/kubectl-argo-rollouts/kubectl-argo-rollouts_undo/">undo</a> command to do the rollback. In our opinion, we don&#8217;t like this procedure because it is not aligned with GitOps. The changes that <strong>Argo Rollouts</strong> do does not come from git, so git is OutOfSync with what we have in Openshift.
In our case the commit that we have done not only changes the ReplicaSet but also the ConfigMap. The <strong>undo</strong> command only changes the ReplicaSet, so it does not work for us.</p>
</div>
<div class="paragraph">
<p>I recommend doing the changes in git. We will revert the last commit</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git revert HEAD --no-edit
git push</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>ArgoCD</strong> will get the changes and apply them. <strong>Argo Rollouts</strong> will create a new revision with the previous version.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-rollback-initial.png" alt="Dstrategies Step Rollback initial">
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc argo rollouts get rollout dstrategies-back --watch -n %USER%-blue-green
NAME                                          KIND         STATUS        AGE   INFO
⟳ dstrategies-back                            Rollout      ॥ Paused      34m
├──# revision:3
│  ├──⧉ dstrategies-back-9d7b5bb4c            ReplicaSet   ✔ Healthy     34m   preview
│  │  └──□ dstrategies-back-9d7b5bb4c-8twhx   Pod          ✔ Running     101s  ready:1/1
│  └──α dstrategies-back-9d7b5bb4c-3-pre      AnalysisRun  ✔ Successful  70s   ✔ 1
└──# revision:2
   ├──⧉ dstrategies-back-7fcdfb7748           ReplicaSet   ✔ Healthy     11m   stable,active
   │  └──□ dstrategies-back-7fcdfb7748-lcldp  Pod          ✔ Running     11m   ready:1/1
   └──α dstrategies-back-7fcdfb7748-2-pre     AnalysisRun  ✔ Successful  11m   ✔ 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute this command to promote dstrategies-back to version <strong>V1.0.0</strong>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc argo rollouts promote dstrategies-back -n %USER%-blue-green</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-rollback.png" alt="DStrategies Step Rollback">
</div>
</div>
<div class="paragraph">
<p>In order to test the online service, it is required to extract the frontend url:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route dstrategies-frontend -n %USER%-blue-green -o jsonpath='{.spec.host}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Visit the frontend route via your web browser, push - JUMP- button and ensure the following message is displaying in your screen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/frontend-blue-green-v1.png" alt="Frontend Interface V1.0.0">
</div>
<div class="title">Figure 4. Frontend Interface</div>
</div>
<div class="paragraph">
<p>The rollback is done!</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-deployment-strategies.html" class="query-params-link">2. Deployment Strategies with Argo CD and Argo Rollouts</a></span>
  <span class="next"><a href="04-canary-deployment.html" class="query-params-link">4. Canary deployment strategy</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
