<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Blue/Green deployment strategy :: Red Hat Workshop - Deployment Strategies with Argo CD and Argo Rollouts</title>
    <link rel="canonical" href="https://github.com/davidseve/redhat-workshop-deployment-strategies/redhat-workshop-deployment-strategies/05-blue-green-deployment.html">
    <link rel="prev" href="03-deployment-strategies.html">
    <link rel="next" href="06-canary-deployment.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://github.com/davidseve/redhat-workshop-deployment-strategies">Red Hat Workshop - Deployment Strategies with Argo CD and Argo Rollouts</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="redhat-workshop-deployment-strategies" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#01-prerequisites">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html#01-laboratory">1.2 Laboratory</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-parameters">1.2.1 Parameters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessconsole">1.2.2 Access - OCP Console</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accesscli">1.2.3 Access - OCP CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessArgoCD">1.2.4 Access - ArgoCD dashboard</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-cloneGit">1.2.5 Clone the GitOps repository</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-deployment-strategies.html">2. Deployment Strategies with Argo CD and Argo Rollouts</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="05-blue-green-deployment.html">3. Blue/Green deployment strategy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-canary-deployment.html">4. Canary deployment strategy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Annex-1-cluster-setup.html">Annex 1 - Cluster Setup</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Workshop</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Workshop</a></li>
    <li><a href="05-blue-green-deployment.html">3. Blue/Green deployment strategy</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/davidseve/redhat-workshop-deployment-strategies/edit/master/documentation/modules/ROOT/pages/05-blue-green-deployment.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Blue/Green deployment strategy</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><strong>Blue-green deployment</strong> is a strategy for updating running computer systems with <strong>minimal downtime</strong>. The operator maintains two environments, dubbed blue and green. One serves production traffic (the version all users use), while the other is updated.</p>
</div>
<div class="paragraph">
<p>For instance, the old version is the blue environment, while the new version is the green environment. Once all the <strong>production traffic is fully transferred from blue to green</strong>, blue can be kept as-is for a possible rollback or be updated to become the template upon which the next update is made.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages:</p>
<div class="ulist">
<ul>
<li>
<p>Minimize downtime.</p>
</li>
<li>
<p>A quick way to roll back.</p>
</li>
<li>
<p>Smoke testing.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Disadvantages:</p>
<div class="ulist">
<ul>
<li>
<p>Doubling of total resources.</p>
</li>
<li>
<p>Backward compatibility.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_bluegreen"><a class="anchor" href="#_how_to_bluegreen"></a>How-to Blue/Green</h3>
<div class="paragraph">
<p>In this example, we have two versions up and running in production: online and offline. We also have routers and services for offline and online pointing to the corresponding microservice. As explained above, we can deploy a new version of the microservice in the green service ("offline") and perform <strong>smoke tests</strong> against it to ensure that the new version will perform correctly when real traffic begins to arrive to Green.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blue-green.png" alt="Blue/Green">
</div>
</div>
<div class="paragraph">
<p>When a new version is ready for real users, we only have to modify the k8s service to point to the new deployment (Green) as in the following image. There is minimal downtime and we can do a rapid rollback just by undoing the changes in the service.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blue-green-switch.png" alt="Blue/Green switch">
</div>
</div>
<div class="paragraph">
<p>As with great power comes great responsibility, you have to take the following into account:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We need to <strong>double the total resources used</strong>: CPU, RAM, Persistent Storage, etc. We will see how to minimize this effect.</p>
</li>
<li>
<p>We have to be <strong>ready for a rapid rollback</strong>. In case of seeing any issue in the monitorization, we should be able to modify the service to point back to the first deployment.</p>
</li>
<li>
<p>We need to keep <strong>backward compatibility</strong>. If not, we would not be able to perform rollbacks.</p>
</li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_shop_application"><a class="anchor" href="#_deploy_shop_application"></a>Deploy Shop Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to create the application <code>dstrategies</code>, that we will use to test Blue/Green deployment. Because we will make changes in the application&#8217;s GitHub repository, we have to use the repository that you have just forked. Please edit the following yaml and set your own GitHub repository in the <code>reportURL</code>. Create a file called <code>application-dstrategies-blue-green.yaml</code></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dstrategies-blue-green
  namespace: %USER%-gitops-argocd
spec:
  destination:
    name: ''
    namespace: %USER%-blue-green
    server: 'https://kubernetes.default.svc'
  source:
    path: helm/helm-umbrella-dstrategies/chart
    repoURL: <a href="https://github.com/change_me/dstrategies-helm-chart" class="bare">https://github.com/change_me/dstrategies-helm-chart</a>
    targetRevision: HEAD
    helm:
      parameters:
      - name: "global.namespace"
        value: %USER%-blue-green
      valueFiles:
        - values/blue-green/values.yaml
        - values/blue-green/values-image-tag.yaml
  project: default
  syncPolicy:
    automated:
      prune: false
      selfHeal: true</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc apply -f application-dstrategies-blue-green.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the Argo CD dashboard, you would notice that we have a new <code>dstrategies</code> application.</p>
</div>
<div class="paragraph">
<p>TODO add image</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_architecture"><a class="anchor" href="#_application_architecture"></a>Application architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To achieve Blue/Green deployment with <code>Cloud Native</code> applications using <strong>Argo Rollouts</strong>, we have designed this architecture.</p>
</div>
<div class="paragraph">
<p>This is our current status:</p>
</div>
<div class="paragraph">
<p>TODO
image::rollout-blue-green-step-0.png["Shop initial status"]</p>
</div>
<div class="paragraph">
<p>OpenShift Components - Online</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Routes and Services declared with the suffix -online</p>
</li>
<li>
<p>Routes mapped only to the online services</p>
</li>
<li>
<p>Services mapped to the rollout.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OpenShift Components - Offline</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Routes and Services declared with the suffix -offline</p>
</li>
<li>
<p>Routes mapped only to the offline services</p>
</li>
<li>
<p>Services mapped to the rollout</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We have defined an active or online service 'dstrategies-back-online' and a preview or offline service 'dstrategies-back-offline'. Final user will always use 'dstrategies-back-online'.</p>
</div>
<div class="paragraph">
<p>We have created an AnalysisTemplate 'dstrategies-back-analysis-template' that just validates the health of the application, for production environments a better analysis should be done. <strong>Argo Rollouts</strong> use this AnalysisTemplate to validate a new version and set whether it is ready to be promoted or not. To learn more, please read <a href="https://argoproj.github.io/argo-rollouts/features/bluegreen/">this</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  strategy:
    blueGreen:
      activeService: dstrategies-back-online
      previewService: dstrategies-back-offline
      autoPromotionEnabled: false
      prePromotionAnalysis:
        templates:
          - templateName: dstrategies-back-analysis-template</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_shop_application"><a class="anchor" href="#_test_shop_application"></a>Test Shop application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have deployed the <code>dstrategies</code> with ArgoCD. We can test that it is up and running.</p>
</div>
<div class="paragraph">
<p>TODO change to front</p>
</div>
<div class="paragraph">
<p>We have to get the Online route</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes dstrategies-back-online -n %USER%-blue-green --template='https://{{.spec.host}}')/dstrategies-back"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the Offline route</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes dstrategies-back-offline -n %USER%-blue-green --template='https://{{.spec.host}}')/dstrategies-back"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in each microservice response we have added metadata information to see better the <code>version</code> of each application. This will help us to see the changes while we do the Blue/Green deployment.
Because right now we have both routers against the same rollout revision we will have the same response with version <code>V1.0.0</code>:</p>
</div>
<div class="paragraph">
<p>We can also see the rollout`s status.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Argo Rollouts offers a Kubectl plugin to enrich the experience with Rollouts <a href="https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation" class="bare">https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation</a>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">kubectl argo rollouts get rollout dstrategies-back --watch -n %USER%-blue-green</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">NAME                                  KIND        STATUS     AGE INFO
⟳ dstrategies-back                            Rollout     ✔ Healthy  12m
└──# revision:1
   └──⧉ dstrategies-back-67fc9fb79b           ReplicaSet  ✔ Healthy  12m  stable,active
      ├──□ dstrategies-back-67fc9fb79b-49k25  Pod         ✔ Running  12m  ready:1/1
      └──□ dstrategies-back-67fc9fb79b-p7jk9  Pod         ✔ Running  12m  ready:1/1</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dstrategies_back_bluegreen_deployment"><a class="anchor" href="#_dstrategies_back_bluegreen_deployment"></a>Dstrategies-back Blue/Green deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have split a <code>Cloud Native</code> Blue/Green deployment into two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy a new version.</p>
</li>
<li>
<p>Promote a new version</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We have already deployed the dstrategies-back version V1.0.0, and we are ready to use a new dstrategies-back version V2.0.0 that has a new <code>description</code> attribute.</p>
</div>
<div class="sect2">
<h3 id="_step_1_deploy_a_new_version"><a class="anchor" href="#_step_1_deploy_a_new_version"></a>Step 1 - Deploy a new version</h3>
<div class="paragraph">
<p>We will deploy a new version <code>V2.0.0</code>. To do it, we have to edit the file <code>helm/helm-umbrella-dstrategies/chart/values/blue-green/values-image-tag.yaml</code> under <code>dstrategies-back</code> set <code>tag</code> value to <code>V2.0.0</code></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">dstrategies-back:
   image:
     tag: V2.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>And push the changes</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git add .
git commit -m "Change dstrategies-back version to V2.0.0"
git push</code></pre>
</div>
</div>
<div class="paragraph">
<p>ArgoCD will refresh the status after some minutes. If you don&#8217;t want to wait you can refresh it manually from ArgoCD UI.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ArgoCD-Shop-Refresh.png" alt="Refresh Shop">
</div>
</div>
<div class="paragraph">
<p><strong>Argo Rollouts</strong> will automatically deploy the new dstrategies-back version and execute the <code>prePromotionAnalysis</code>.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">NAME                                  KIND         STATUS        AGE  INFO
⟳ dstrategies-back                            Rollout      ॥ Paused      27m
├──# revision:2
│  ├──⧉ dstrategies-back-9dc6f576f            ReplicaSet   ✔ Healthy     36s  preview
│  │  ├──□ dstrategies-back-9dc6f576f-6vqp5   Pod          ✔ Running     36s  ready:1/1
│  │  └──□ dstrategies-back-9dc6f576f-lmgd7   Pod          ✔ Running     36s  ready:1/1
│  └──α dstrategies-back-9dc6f576f-2-pre      AnalysisRun  ✔ Successful  31s  ✔ 1
└──# revision:1
   └──⧉ dstrategies-back-67fc9fb79b           ReplicaSet   ✔ Healthy     27m  stable,active
      ├──□ dstrategies-back-67fc9fb79b-49k25  Pod          ✔ Running     27m  ready:1/1
      └──□ dstrategies-back-67fc9fb79b-p7jk9  Pod          ✔ Running     27m  ready:1/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>prePromotionAnalysis</code> goes well, we can see that offline applications have version V2.0.0 and the new attribute description, but the online version has not changed.</p>
</div>
<div class="paragraph">
<p>This is our current status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-1.png" alt="Shop Step 1]">
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>TODO add fornt image</pre>
</div>
</div>
<div class="paragraph">
<p>Functional testing users can execute <code>Smoke tests</code> to validate this new V2.0.0 version.</p>
</div>
<div class="paragraph">
<p>We have to be careful with those tests in a production environment because the product microservice will call the online dependencies.
If this dependency is for example a production DB we will create the things that our <code>Smoke tests</code> do.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_promote_a_new_version"><a class="anchor" href="#_step_2_promote_a_new_version"></a>Step 2 - Promote a new version</h3>
<div class="paragraph">
<p>We are going to open the new version to final users.</p>
</div>
<div class="paragraph">
<p>Execute this command to promote dstrategies-back:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">kubectl argo rollouts promote dstrategies-back -n %USER%-blue-green</code></pre>
</div>
</div>
<div class="paragraph">
<p>First <strong>Argo Rollouts</strong> will just change the service to use the new release (ReplicaSet). We <code>minimize downtime</code> because it just changes the service label.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">NAME                                  KIND         STATUS        AGE  INFO
⟳ dstrategies-back                            Rollout      ✔ Healthy     88m
├──# revision:2
│  ├──⧉ dstrategies-back-9dc6f576f            ReplicaSet   ✔ Healthy     62m  stable,active
│  │  ├──□ dstrategies-back-9dc6f576f-6vqp5   Pod          ✔ Running     62m  ready:1/1
│  │  └──□ dstrategies-back-9dc6f576f-lmgd7   Pod          ✔ Running     62m  ready:1/1
│  └──α dstrategies-back-9dc6f576f-2-pre      AnalysisRun  ✔ Successful  62m  ✔ 1
└──# revision:1
   └──⧉ dstrategies-back-67fc9fb79b           ReplicaSet   ✔ Healthy     88m  delay:27s
      ├──□ dstrategies-back-67fc9fb79b-49k25  Pod          ✔ Running     88m  ready:1/1
      └──□ dstrategies-back-67fc9fb79b-p7jk9  Pod          ✔ Running     88m  ready:1/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is our current status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-2-initial.png" alt="Shop Step 2 initial">
</div>
</div>
<div class="paragraph">
<p>And after <code>scaleDownDelaySeconds</code> <strong>Argo Rollouts</strong> will scale down the first replicaSet (V1.0.0).</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input"> NAME                                 KIND         STATUS        AGE  INFO
⟳ dstrategies-back                           Rollout      ✔ Healthy     89m
├──# revision:2
│  ├──⧉ dstrategies-back-9dc6f576f           ReplicaSet   ✔ Healthy     62m  stable,active
│  │  ├──□ dstrategies-back-9dc6f576f-6vqp5  Pod          ✔ Running     62m  ready:1/1
│  │  └──□ dstrategies-back-9dc6f576f-lmgd7  Pod          ✔ Running     62m  ready:1/1
│  └──α dstrategies-back-9dc6f576f-2-pre     AnalysisRun  ✔ Successful  62m  ✔ 1
└──# revision:1
   └──⧉ dstrategies-back-67fc9fb79b          ReplicaSet   • ScaledDown  89m</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is our final status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-2.png" alt="Shop Step 2">
</div>
</div>
<div class="paragraph">
<p>TODO add front image</p>
</div>
<div class="paragraph">
<p><strong>We have in the online environment the new version V2.0.0!!!</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_rollback"><a class="anchor" href="#_rollback"></a>Rollback</h3>
<div class="paragraph">
<p>Imagine that something goes wrong, we know that this never happens but just in case. We can do a very <code>quick rollback</code> just by undoing the change in the <code>dstrategies-back</code> online service.</p>
</div>
<div class="paragraph">
<p><strong>Argo Rollouts</strong> has an <a href="https://argoproj.github.io/argo-rollouts/generated/kubectl-argo-rollouts/kubectl-argo-rollouts_undo/">undo</a> command to do the rollback. In our opinion, we don&#8217;t like this procedure because it is not aligned with GitOps. The changes that <strong>Argo Rollouts</strong> do does not come from git, so git is OutOfSync with what we have in Openshift.
In our case the commit that we have done not only changes the ReplicaSet but also the ConfigMap. The <code>undo</code> command only changes the ReplicaSet, so it does not work for us.</p>
</div>
<div class="paragraph">
<p>I recommend doing the changes in git. We will revert the last commit</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git revert HEAD --no-edit
git push</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>ArgoCD</strong> will get the changes and apply them. <strong>Argo Rollouts</strong> will create a new revision with the previous version.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-rollback-initial.png" alt="Shop Step Rollback initial">
</div>
</div>
<div class="paragraph">
<p>Execute this command to promote dstrategies-back to version <code>V1.0.0</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">kubectl argo rollouts promote dstrategies-back -n %USER%-blue-green</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rollback is done!</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollout-blue-green-step-rollback.png" alt="Shop Step Rollback">
</div>
</div>
<div class="paragraph">
<p>TODO add front image</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-deployment-strategies.html" class="query-params-link">2. Deployment Strategies with Argo CD and Argo Rollouts</a></span>
  <span class="next"><a href="06-canary-deployment.html" class="query-params-link">4. Canary deployment strategy</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
